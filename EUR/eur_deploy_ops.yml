---
- name: EUR VM DEPLOYMENTS
  hosts: eur
  gather_facts: false
  become: true
  collections:
    - community.vmware

  vars_files:
    - vars_eur_vms.yml

  tasks:
    - name: Fetching VMs List
      set_fact:
        unregvms: "{{ ovavms1 | list + isovms2 | list + ovavms3 | list + ovavms4 | list + ovavms5 }}"

    - name: Unregister All VMs
      community.vmware.vmware_guest_register_operation:
        hostname: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        name: "{{ item.ovaname1 | default(item.isoname2) | default(item.ovaname3) | default(item.ovaname4) | default(item.ovaname5) }}"
        esxi_hostname: "{{ ansible_host }}"
        folder: '/vm'
        state: absent
        validate_certs: false
      loop: "{{ unregvms }}"
      delegate_to: localhost

    - name: Moving VMs to VM Folder
      ansible.builtin.shell:
        cmd: mv /vmfs/volumes/"{{ dstore1 }}"/EUR-* /vmfs/volumes/"{{ dstore1 }}"/VM/
      become: true
      delegate_to: eur

    - name: Waiting 120 Seconds
      ansible.builtin.wait_for:
        timeout: 120
      delegate_to: localhost

    - name: Preparing VMs List To Register
      set_fact:
        regvms1: "{{ ovavms1 | map('combine', {'type': 'vmx'}) | list + isovms2 | map('combine', {'type': 'vmx'}) | list }}"

    - name: Registering VMs
      ansible.builtin.shell:
        cmd: /bin/vim-cmd solo/registervm /vmfs/volumes/"{{ dstore1 }}"/VM/"{{ item.ovaname1 | default(item.isoname2) }}"/"{{ item.ovaname1 | default(item.isoname2) }}".vmx
      loop: "{{ regvms1 }}"
      become: true
      delegate_to: eur

    - name: Registering StarWind vSAN1
      ansible.builtin.shell:
        cmd: /bin/vim-cmd solo/registervm /vmfs/volumes/"{{ dstore2 }}"/EUR-SWND-VSN1/EUR-SWND-VSN1.vmx
      become: true
      delegate_to: eur

    - name: Registering StarWind vSAN2
      ansible.builtin.shell:
        cmd: /bin/vim-cmd solo/registervm /vmfs/volumes/"{{ dstore2 }}"/EUR-SWND-VSN2/EUR-SWND-VSN2.vmx
      become: true
      delegate_to: eur

    - name: Register StarWind Veeam
      ansible.builtin.shell:
        cmd: /bin/vim-cmd solo/registervm /vmfs/volumes/"{{ dstore3 }}"/EUR-SWND-VBR/EUR-SWND-VBR.vmx
      become: true
      delegate_to: eur

    - name: Preparing VMs List To Register
      set_fact:
        regvms1: "{{ ovavms4 | map('combine', {'type': 'vmx'}) | list + ovavms5 | map('combine', {'type': 'vmx'}) | list }}"

    - name: Registering VMs
      ansible.builtin.shell:
        cmd: /bin/vim-cmd solo/registervm /vmfs/volumes/"{{ dstore1 }}"/VM/"{{ item.ovaname4 | default(item.ovaname5) }}"/"{{ item.ovaname4 | default(item.ovaname5) }}".vmx
      loop: "{{ regvms1 }}"
      become: true
      delegate_to: eur

    - name: Adding UUID Action Keep To VMs
      ansible.builtin.shell:
        cmd: find /vmfs/volumes/"{{ dstore1 }}"/VM -type f -name "*.vmx" -exec sh -c 'echo "uuid.action = keep" >> "$1"' -- {} \;
      become: true
      delegate_to: eur

    - name: Adding UUID Action Keep To StarWind vSAN1
      ansible.builtin.shell:
        cmd: find /vmfs/volumes/"{{ dstore2 }}" -type f -name "*.vmx" -exec sh -c 'echo "uuid.action = keep" >> "$1"' -- {} \;
      become: true
      delegate_to: eur

    - name: Adding UUID Action Keep To StarWind vSAN2
      ansible.builtin.shell:
        cmd: find /vmfs/volumes/"{{ dstore2 }}" -type f -name "*.vmx" -exec sh -c 'echo "uuid.action = keep" >> "$1"' -- {} \;
      become: true
      delegate_to: eur

    - name: Adding UUID Action Keep To StarWind Veeam
      ansible.builtin.shell:
        cmd: find /vmfs/volumes/"{{ dstore3 }}" -type f -name "*.vmx" -exec sh -c 'echo "uuid.action = keep" >> "$1"' -- {} \;
      become: true
      delegate_to: eur
